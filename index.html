<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Poster Maker</title>

<style>
@font-face{
  font-family:'Malayalam';
  src:url('fonts/NotoSansMalayalam-Regular.ttf');
}
body{
  font-family:Arial, sans-serif;
  background:#f2f2f2;
  padding:10px;
}
input,button,select{
  width:100%;
  padding:10px;
  margin:6px 0;
  font-size:16px;
}
button{
  background:#0a7cff;
  color:#fff;
  border:none;
  border-radius:6px;
}
.section{
  background:#fff;
  padding:10px;
  border-radius:6px;
  margin-bottom:10px;
}
.list-item{
  border-bottom:1px solid #ddd;
  padding:6px 0;
  font-size:14px;
}
.list-item button{
  margin-left:6px;
}
img{
  width:100%;
  margin-top:10px;
}
canvas{display:none;}
.small{font-size:13px;color:#555;}
</style>
</head>

<body>

<h3>üñºÔ∏è Daily Price Poster Maker</h3>

<!-- ================= ADD ITEM ================= -->
<div class="section">
<h4>‚ûï Daily Item</h4>

<input type="file" id="photo" accept="image/*" capture="environment">

<input list="mlList" id="nameML" placeholder="‡¥á‡¥®‡¥§‡µç‡¥§‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥™‡µá‡¥∞‡µç (Malayalam)">
<datalist id="mlList"></datalist>

<input id="nameEN" placeholder="Item Name (English)">
<input id="price" placeholder="‡¥µ‡¥ø‡¥≤ (‚Çπ / Kg)">

<button onclick="addItem()">‚ûï Add Item</button>
<div class="small">‚ÑπÔ∏è Item name ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Ç pre-list-‡µΩ save ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥Ç</div>
</div>

<!-- ================= TODAY ITEMS ================= -->
<div class="section">
<h4>üìã Today Items</h4>
<div id="itemList"></div>
</div>

<!-- ================= PRE-LIST ================= -->
<div class="section">
<h4>üóÇÔ∏è Pre-List (Memory)</h4>
<input id="preListSearch" placeholder="üîç Search"
       oninput="renderPreList(this.value)">
<div id="preListManager"></div>
</div>

<!-- ================= SIZE ================= -->
<div class="section">
<h4>üìê WhatsApp Size</h4>
<select id="waSize">
  <option value="status">WhatsApp Status (9:16)</option>
  <option value="chat">WhatsApp Chat (4:5)</option>
</select>
</div>

<button onclick="generatePoster()">üñºÔ∏è Generate Poster</button>

<img id="preview">
<canvas id="canvas"></canvas>

<script>
/* ================= GLOBAL STATE ================= */
let items = [];
let preList = [];

/* ================= STORAGE KEY ================= */
const PRELIST_KEY = "DAILY_POSTER_PRELIST_V1";

/* ================= ELEMENTS ================= */
const mlInput = document.getElementById("nameML");
const enInput = document.getElementById("nameEN");
const priceInput = document.getElementById("price");
const mlList = document.getElementById("mlList");
const itemListDiv = document.getElementById("itemList");
const preListManagerDiv = document.getElementById("preListManager");

/* ================= LOAD PRE-LIST ================= */
function loadPreList(){
  try{
    const raw = localStorage.getItem(PRELIST_KEY);
    preList = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(preList)) preList = [];
  }catch{
    preList = [];
    localStorage.removeItem(PRELIST_KEY);
  }
}

/* ================= SAVE PRE-LIST ================= */
function savePreList(){
  localStorage.setItem(PRELIST_KEY, JSON.stringify(preList));
  rebuildPreListUI();
}

/* ================= BUILD PRE-LIST UI ================= */
function rebuildPreListUI(){
  mlList.innerHTML="";
  preList.forEach(it=>{
    const o=document.createElement("option");
    o.value=it.ml;
    mlList.appendChild(o);
  });
  renderPreList("");
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded",()=>{
  loadPreList();
  rebuildPreListUI();
});

/* ================= AUTO ENGLISH ================= */
mlInput.addEventListener("input",()=>{
  const f = preList.find(i=>i.ml===mlInput.value.trim());
  enInput.value = f ? f.en : "";
});

/* ================= ADD ITEM ================= */
function addItem(){
  const ml = mlInput.value.trim();
  const en = enInput.value.trim();
  const price = priceInput.value.trim();
  const photo = document.getElementById("photo").files[0];

  if(!ml || !en || !price || !photo){
    alert("‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥Ç ‡¥®‡µΩ‡¥ï‡¥£‡¥Ç");
    return;
  }

  items.push({ml,en,price,photo});

  if(!preList.find(i=>i.ml===ml)){
    preList.push({ml,en});
    savePreList();
  }

  mlInput.value="";
  enInput.value="";
  priceInput.value="";
  document.getElementById("photo").value="";

  renderTodayList();
}

/* ================= TODAY LIST ================= */
function renderTodayList(){
  itemListDiv.innerHTML="";
  items.forEach((it,i)=>{
    itemListDiv.innerHTML+=`
      <div class="list-item">
        ${it.ml} ‚Äì ${it.en} ‚Äì ‚Çπ${it.price}
        <button onclick="items.splice(${i},1);renderTodayList()">‚ùå</button>
      </div>`;
  });
}

/* ================= PRE-LIST SEARCH ================= */
function renderPreList(q){
  q=q.toLowerCase();
  preListManagerDiv.innerHTML="";
  preList.forEach(it=>{
    if(it.ml.toLowerCase().includes(q) ||
       it.en.toLowerCase().includes(q)){
      preListManagerDiv.innerHTML+=`
        <div class="list-item">
          ${it.ml} ‚Äì ${it.en}
          <button onclick="selectPreItem('${it.ml}','${it.en}')">‚ûï Today</button>
        </div>`;
    }
  });
}
function selectPreItem(ml,en){
  mlInput.value=ml;
  enInput.value=en;
}

/* ================= POSTER ================= */
function generatePoster(){

  if(items.length===0){
    alert("‡¥á‡¥®‡¥ô‡µç‡¥ô‡µæ add ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥ø‡¥ü‡µç‡¥ü‡¥ø‡¥≤‡µç‡¥≤");
    return;
  }

  const mode = document.getElementById("waSize").value;
  const canvasWidth = 1080;
  const headerHeight = mode==="status" ? 280 : 220;
  const footerHeight = 110;
  const topMargin = 60;
  const gap = 24;

  let imageHeights=[];
  let loaded=0;

  items.forEach((it,i)=>{
    const img=new Image();
    img.onload=()=>{
      const ratio = img.width / img.height;
      imageHeights[i] = canvasWidth / ratio;
      loaded++;
      if(loaded===items.length) drawPoster();
    };
    img.src=URL.createObjectURL(it.photo);
  });

  function drawPoster(){

    let totalHeight = headerHeight + topMargin + footerHeight;
    imageHeights.forEach(h=> totalHeight += h + gap);

    canvas.width = canvasWidth;
    canvas.height = totalHeight;

    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";

    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const hImg=new Image();
    hImg.onload=()=>{
      ctx.drawImage(hImg,0,0,canvasWidth,headerHeight);

      ctx.fillStyle="rgba(0,0,0,0.55)";
      ctx.fillRect((canvasWidth-320)/2,24,320,60);
      ctx.fillStyle="#fff";
      ctx.font="bold 34px Arial";
      ctx.textAlign="center";
      ctx.fillText(new Date().toLocaleDateString("en-GB"),
                   canvasWidth/2,66);
      ctx.textAlign="left";

      let y = headerHeight + topMargin;

      const drawItem=(i)=>{
        if(i>=items.length){
          ctx.fillStyle="#222";
          ctx.fillRect(0,canvas.height-footerHeight,
                       canvasWidth,footerHeight);
          ctx.fillStyle="#fff";
          ctx.font="28px Arial";
          ctx.fillText("üìû ‡¥π‡µã‡¥Ç ‡¥°‡µÜ‡¥≤‡¥ø‡¥µ‡¥±‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ø‡¥ø 9846 606 609",
                       40,canvas.height-45);
          preview.src = canvas.toDataURL("image/jpeg",1);
          return;
        }

        const it=items[i];
        const img=new Image();
        img.onload=()=>{
          const h=imageHeights[i];
          ctx.drawImage(img,0,y,canvasWidth,h);

          ctx.fillStyle="rgba(0,0,0,0.6)";
          ctx.fillRect(0,y+h-120,canvasWidth,120);

          ctx.fillStyle="#fff";
          ctx.font="bold 42px Malayalam";
          ctx.fillText(it.ml,30,y+h-70);

          ctx.font="26px Arial";
          ctx.fillText(it.en,30,y+h-35);

          ctx.font="bold 40px Arial";
          ctx.textAlign="right";
          ctx.fillText("‚Çπ "+it.price,
                       canvasWidth-30,y+h-60);
          ctx.textAlign="left";

          y += h + gap;
          drawItem(i+1);
        };
        img.src=URL.createObjectURL(it.photo);
      };
      drawItem(0);
    };
    hImg.src="header.jpg";
  }
}
</script>

</body>
</html>
