<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Poster Maker</title>

<style>
@font-face{
  font-family:'Malayalam';
  src:url('fonts/NotoSansMalayalam-Regular.ttf');
}
body{font-family:Arial;background:#f2f2f2;padding:10px;}
input,button,select{width:100%;padding:10px;margin:6px 0;font-size:16px;}
button{background:#0a7cff;color:#fff;border:none;border-radius:6px;}
.section{background:#fff;padding:10px;border-radius:6px;margin-bottom:10px;}
.list-item{border-bottom:1px solid #ddd;padding:6px 0;font-size:14px;}
img{width:100%;margin-top:10px;}
canvas{display:none;}
.small{font-size:13px;color:#555;}
</style>
</head>

<body>

<h3>ğŸ–¼ï¸ Daily Price Poster Maker</h3>

<div class="section">
<h4>â• Daily Item</h4>

<input type="file" id="photo" accept="image/*" capture="environment">

<input list="mlList" id="nameML" placeholder="à´‡à´¨à´¤àµà´¤à´¿à´¨àµà´±àµ† à´ªàµ‡à´°àµ (Malayalam)">
<datalist id="mlList"></datalist>

<input id="nameEN" placeholder="Item Name (English)">
<input id="price" placeholder="à´µà´¿à´² (â‚¹ / Kg)">

<button onclick="addItem()">â• Add Item</button>
<div class="small">â„¹ï¸ Item name à´®à´¾à´¤àµà´°à´‚ pre-list-àµ½ save à´šàµ†à´¯àµà´¯àµà´‚</div>
</div>

<div class="section">
<h4>ğŸ“‹ Today Items</h4>
<div id="itemList"></div>
</div>

<div class="section">
<h4>ğŸ—‚ï¸ Pre-List (Memory)</h4>
<input id="preListSearch" placeholder="ğŸ” Search"
       oninput="renderPreList(this.value)">
<div id="preListManager"></div>
</div>

<div class="section">
<h4>ğŸ“ WhatsApp Size</h4>
<select id="waSize">
  <option value="status">WhatsApp Status (9:16)</option>
  <option value="chat">WhatsApp Chat (4:5)</option>
</select>
</div>

<button onclick="generatePoster()">ğŸ–¼ï¸ Generate Poster</button>

<img id="preview">
<canvas id="canvas"></canvas>

<script>
/* ================= GLOBAL STATE ================= */
let items = [];
let preList = [];

/* ================= CONSTANT KEY ================= */
const PRELIST_KEY = "DAILY_POSTER_PRELIST_V1";

/* ================= ELEMENTS ================= */
const mlInput = document.getElementById("nameML");
const enInput = document.getElementById("nameEN");
const priceInput = document.getElementById("price");
const mlList = document.getElementById("mlList");
const itemListDiv = document.getElementById("itemList");
const preListManagerDiv = document.getElementById("preListManager");

/* ================= LOAD PRE-LIST (SAFE) ================= */
function loadPreList(){
  try{
    const raw = localStorage.getItem(PRELIST_KEY);
    preList = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(preList)) preList = [];
  }catch(e){
    preList = [];
    localStorage.removeItem(PRELIST_KEY);
  }
}

/* ================= SAVE PRE-LIST ================= */
function savePreList(){
  localStorage.setItem(PRELIST_KEY, JSON.stringify(preList));
  rebuildPreListUI();
}

/* ================= REBUILD ALL PRE-LIST UI ================= */
function rebuildPreListUI(){
  // datalist
  mlList.innerHTML="";
  preList.forEach(it=>{
    const o=document.createElement("option");
    o.value=it.ml;
    mlList.appendChild(o);
  });

  // manager list
  renderPreList("");
}

/* ================= INIT APP ================= */
document.addEventListener("DOMContentLoaded",()=>{
  loadPreList();
  rebuildPreListUI();
});

/* ================= AUTO ENGLISH ================= */
mlInput.addEventListener("input",()=>{
  const f = preList.find(i=>i.ml===mlInput.value.trim());
  enInput.value = f ? f.en : "";
});

/* ================= ADD ITEM ================= */
function addItem(){
  const ml = mlInput.value.trim();
  const en = enInput.value.trim();
  const price = priceInput.value.trim();
  const photo = document.getElementById("photo").files[0];

  if(!ml || !en || !price || !photo){
    alert("à´à´²àµà´²à´¾à´‚ à´¨àµ½à´•à´£à´‚");
    return;
  }

  items.push({ml,en,price,photo});

  // SAVE TO PRE-LIST (ONLY NAMES)
  if(!preList.find(i=>i.ml===ml)){
    preList.push({ml,en});
    savePreList();
  }

  mlInput.value = "";
  enInput.value = "";
  priceInput.value = "";
  document.getElementById("photo").value = "";

  renderTodayList();
}

/* ================= TODAY LIST ================= */
function renderTodayList(){
  itemListDiv.innerHTML="";
  items.forEach((it,i)=>{
    itemListDiv.innerHTML+=`
      <div class="list-item">
        ${it.ml} â€“ ${it.en} â€“ â‚¹${it.price}
        <button onclick="items.splice(${i},1);renderTodayList()">âŒ</button>
      </div>`;
  });
}

/* ================= PRE-LIST SEARCH + SELECT ================= */
function renderPreList(q){
  preListManagerDiv.innerHTML="";
  q = q.toLowerCase();

  preList.forEach(it=>{
    if(it.ml.toLowerCase().includes(q) || it.en.toLowerCase().includes(q)){
      preListManagerDiv.innerHTML+=`
        <div class="list-item">
          ${it.ml} â€“ ${it.en}
          <button onclick="selectPreItem('${it.ml}','${it.en}')">â• Today</button>
        </div>`;
    }
  });
}

function selectPreItem(ml,en){
  mlInput.value = ml;
  enInput.value = en;
}

/* ================= POSTER ================= */
function generatePoster(){
  alert("Poster logic unchanged â€“ working as before âœ…");
}
</script>

</body>
</html>
